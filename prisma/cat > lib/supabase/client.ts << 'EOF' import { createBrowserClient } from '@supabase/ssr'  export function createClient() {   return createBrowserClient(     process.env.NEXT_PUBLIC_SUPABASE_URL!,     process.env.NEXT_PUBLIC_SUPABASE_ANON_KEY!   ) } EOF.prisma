generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// MULTI-TENANCY & AUTHENTICATION
// ============================================

model Organization {
  id                String   @id @default(cuid())
  name              String
  slug              String   @unique
  status            OrganizationStatus @default(ACTIVE)
  subscriptionPlan  SubscriptionPlan   @default(STARTER)
  
  // Contact & Billing
  contactEmail      String
  contactName       String?
  billingAddress    String?
  phone             String?
  
  // Settings
  defaultCurrency   String   @default("USD")
  defaultTimezone   String   @default("UTC")
  logoUrl           String?
  
  // Timestamps
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  users             User[]
  features          OrganizationFeature[]
  voyages           Voyage[]
  auditLogs         AuditLog[]
  
  @@map("organizations")
}

enum OrganizationStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
  TRIAL
}

enum SubscriptionPlan {
  STARTER
  PROFESSIONAL
  ENTERPRISE
  CUSTOM
}

model User {
  id              String   @id @default(cuid())
  email           String   @unique
  organizationId  String?
  
  // Profile
  firstName       String?
  lastName        String?
  avatarUrl       String?
  
  // Access Control
  role            UserRole
  status          UserStatus @default(ACTIVE)
  
  // Auth (Supabase)
  supabaseUserId  String   @unique
  lastLoginAt     DateTime?
  
  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  organization    Organization? @relation(fields: [organizationId], references: [id])
  createdVoyages  Voyage[]
  auditLogs       AuditLog[]
  
  @@map("users")
}

enum UserRole {
  ROOT_ADMIN
  CUSTOMER_ADMIN
  MANAGER
  OPERATOR
  VIEWER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model OrganizationFeature {
  id              String   @id @default(cuid())
  organizationId  String
  featureName     String
  enabled         Boolean  @default(true)
  limitValue      Int?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@unique([organizationId, featureName])
  @@map("organization_features")
}

model AuditLog {
  id              String   @id @default(cuid())
  organizationId  String?
  userId          String?
  
  action          String
  resourceType    String
  resourceId      String?
  metadata        Json?
  ipAddress       String?
  userAgent       String?
  
  createdAt       DateTime @default(now())
  
  organization    Organization? @relation(fields: [organizationId], references: [id])
  user            User?        @relation(fields: [userId], references: [id])
  
  @@index([organizationId, createdAt])
  @@index([userId])
  @@map("audit_logs")
}


// ============================================
// LAYTIME DOMAIN MODELS
// ============================================

model Voyage {
  id              String   @id @default(cuid())
  organizationId  String
  vesselName      String
  voyageNumber    String
  status          VoyageStatus @default(ESTIMATE)
  currency        String   @default("USD")
  
  startDate       DateTime?
  endDate         DateTime?
  
  createdById     String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy       User         @relation(fields: [createdById], references: [id])
  portCalls       PortCall[]
  cargoes         Cargo[]
  charterParties  CharterParty[]
  laytimeCalcs    LaytimeCalculation[]
  
  @@index([organizationId])
  @@map("voyages")
}

enum VoyageStatus {
  ESTIMATE
  ACTUAL
  FROZEN
}

model PortCall {
  id              String   @id @default(cuid())
  voyageId        String
  portCode        String
  portName        String
  sequenceNumber  Int
  
  // Timestamps
  eta             DateTime?
  ata             DateTime?
  atBerth         DateTime?
  opsCompleted    DateTime?
  departure       DateTime?
  
  timezone        String   @default("UTC")
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  voyage          Voyage   @relation(fields: [voyageId], references: [id], onDelete: Cascade)
  loadCargoes     Cargo[]  @relation("LoadPort")
  dischargeCargoes Cargo[] @relation("DischargePort")
  activities      PortActivity[]
  
  @@index([voyageId])
  @@map("port_calls")
}

model Cargo {
  id                  String   @id @default(cuid())
  voyageId            String
  cpId                String?
  cargoName           String
  grade               String?
  quantity            Decimal
  unit                String   @default("MT")
  
  loadPortCallId      String
  dischargePortCallId String
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  voyage              Voyage      @relation(fields: [voyageId], references: [id], onDelete: Cascade)
  charterParty        CharterParty? @relation(fields: [cpId], references: [id])
  loadPort            PortCall    @relation("LoadPort", fields: [loadPortCallId], references: [id])
  dischargePort       PortCall    @relation("DischargePort", fields: [dischargePortCallId], references: [id])
  
  @@index([voyageId])
  @@map("cargoes")
}

model CharterParty {
  id                      String   @id @default(cuid())
  voyageId                String
  cpNumber                String
  chartererName           String
  
  // Laytime Terms
  laytimeAllowedValue     Decimal
  laytimeAllowedUnit      LaytimeUnit
  laytimeScope            LaytimeScope @default(PER_PORT)
  
  // Rates
  demurrageRatePerDay     Decimal
  despatchRatePerDay      Decimal?
  currency                String   @default("USD")
  
  // Advanced Features
  reversibleTermsEnabled  Boolean  @default(false)
  prorationAllowed        Boolean  @default(false)
  cargoMatchAllowed       Boolean  @default(false)
  despatchApplicable      Boolean  @default(true)
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  
  // Relations
  voyage                  Voyage   @relation(fields: [voyageId], references: [id], onDelete: Cascade)
  cargoes                 Cargo[]
  
  @@index([voyageId])
  @@map("charter_parties")
}

enum LaytimeUnit {
  HOURS
  DAYS
  TONNES_PER_DAY
}

enum LaytimeScope {
  PER_PORT
  AGGREGATE_PORTS
  PER_OPERATION
}

model LaytimeCalculation {
  id                      String   @id @default(cuid())
  voyageId                String
  status                  CalcStatus @default(DRAFT)
  calculationMethod       String   @default("STANDARD")
  
  // Results
  timeOnDemurrageMinutes  Int      @default(0)
  timeOnDespatchMinutes   Int      @default(0)
  timeUsedMinutes         Int      @default(0)
  timeAllowedMinutes      Int      @default(0)
  
  demurrageAmount         Decimal  @default(0)
  despatchAmount          Decimal  @default(0)
  currency                String   @default("USD")
  
  statementNumber         String?
  notes                   String?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  
  // Relations
  voyage                  Voyage   @relation(fields: [voyageId], references: [id], onDelete: Cascade)
  activities              PortActivity[]
  
  @@index([voyageId])
  @@map("laytime_calculations")
}

enum CalcStatus {
  DRAFT
  FINAL
  CANCELLED
}

model PortActivity {
  id                      String   @id @default(cuid())
  laytimeCalculationId    String
  portCallId              String
  eventType               EventType
  
  fromDateTime            DateTime
  toDateTime              DateTime?
  durationMinutes         Int?
  
  countBehavior           CountBehavior @default(FULL)
  deductionReasonCode     String?
  description             String?
  source                  EventSource   @default(MANUAL)
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  
  // Relations
  laytimeCalculation      LaytimeCalculation @relation(fields: [laytimeCalculationId], references: [id], onDelete: Cascade)
  
  @@index([laytimeCalculationId])
  @@map("port_activities")
}

enum EventType {
  ARRIVAL
  NOR_TENDERED
  NOR_ACCEPTED
  BERTHED
  COMMENCED_LOADING
  COMMENCED_DISCHARGE
  STOPPED
  RESUMED
  COMPLETED
  DEPARTURE
  SHIFTING
  WEATHER
  HOLIDAY
  STRIKE
  BREAKDOWN
  WAITING
  CUSTOM
}

enum CountBehavior {
  FULL
  HALF
  NONE
  PERCENT_25
  PERCENT_50
  PERCENT_75
}

enum EventSource {
  IMPORTED
  MANUAL
  ADJUSTED
}

